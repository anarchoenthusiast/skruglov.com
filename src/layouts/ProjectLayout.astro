---
import Container from "@components/Container.astro";
import PageLayout from "@layouts/PageLayout.astro";
import type { CollectionEntry } from "astro:content";
import CTA from "@components/CTA.astro";
import { SITE } from "@consts";
import { getCollection } from "astro:content";

interface Props {
  project: CollectionEntry<"projects">;
}

const { project } = Astro.props;
const { Content } = await project.render();

// Получаем параметр from из URL для передачи в ссылки на другие проекты
// Используем 'projects' только если нет ни URL параметра, ни сохраненного значения
const fromParam = Astro.url.searchParams.get('from') || 'projects';

// SEO: определяем canonical URL без параметров и robots meta
const canonicalURL = new URL(`/projects/${project.slug}/`, Astro.site).href;
const hasFromParam = Astro.url.searchParams.has('from');
const robotsMeta = hasFromParam ? 'noindex, follow' : undefined;

// SEO: структурированные данные для проекта
const structuredData = {
  "@context": "https://schema.org",
  "@type": "CreativeWork",
  "name": project.data.title,
  "description": project.data.description,
  "url": canonicalURL,
  "creator": {
    "@type": "Person",
    "name": "Sergey Kruglov",
    "jobTitle": "Product Designer and Engineer"
  },
  "dateCreated": project.data.date.toISOString(),
  "genre": project.data.projectType,
  "keywords": [project.data.projectType, project.data.role, project.data.scope].filter(Boolean).join(", "),
  ...(project.data.images && project.data.images.length > 0 && {
    "image": new URL(project.data.images[0].url, Astro.site).href
  })
};

// SEO: Open Graph данные
const ogImage = project.data.images && project.data.images.length > 0 
  ? project.data.images[0].url 
  : undefined;

// Получаем все проекты, исключая текущий
const allProjects = await getCollection("projects");
const otherProjects = allProjects
  .filter(p => p.slug !== project.slug)
  .sort((a, b) => {
    // Если есть поле priority, сортируем по нему (меньшее значение = выше)
    if (a.data.priority !== undefined && b.data.priority !== undefined) {
      // При возрастающей сортировке первым будет проект с меньшим priority
      return a.data.priority - b.data.priority;
    }
    // Если у одного проекта есть priority, а у другого нет, приоритетный проект должен быть выше
    if (a.data.priority !== undefined && b.data.priority === undefined) {
      return -1;
    }
    if (a.data.priority === undefined && b.data.priority !== undefined) {
      return 1;
    }
    // По умолчанию сортируем по дате (более новые выше)
    return b.data.date.valueOf() - a.data.date.valueOf();
  })
  .slice(0, 3);

const breadcrumbs = [
  { label: SITE.NAME, url: '/' },
  { label: 'Projects', url: '/projects' },
  { label: project.data.title }
];
---

<PageLayout 
  title={project.data.title} 
  description={project.data.description} 
  pageType="project"
  breadcrumbs={breadcrumbs}
  canonicalURL={canonicalURL}
  robots={robotsMeta}
  structuredData={structuredData}
  ogType="article"
  ogImage={ogImage}
>
  <!-- Контент страницы с анимацией -->
  <div class="project-page-content">
    <Container size="project">
      <div class="grid grid-cols-1 gap-8">
        <!-- Информация о проекте -->
        <div class="animate">
          <!-- Блок с информацией о проекте в две строки по три элемента -->
          <div class="space-y-6">
            <div class="grid grid-cols-2 md:grid-cols-3 gap-6">
              <div>
                <h6 class="project-label">Role</h6>
                <p class="project-value">{project.data.role}</p>
              </div>
              
              <div>
                <h6 class="project-label">Project Type</h6>
                <p class="project-value">{project.data.projectType}</p>
              </div>
              
              <div>
                <h6 class="project-label">Duration</h6>
                <p class="project-value">{project.data.duration}</p>
              </div>
            
              <div>
                <h6 class="project-label">Scope</h6>
                <p class="project-value">{project.data.scope}</p>
              </div>
              
              <div>
                <h6 class="project-label">Contributions</h6>
                <p class="project-value">{project.data.contributions}</p>
              </div>
              
              <div>
                <h6 class="project-label">Collaborators</h6>
                <p class="project-value">{project.data.collaborators}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Контент проекта и изображения -->
        <div class="animate mt-8">
          <Content />
        </div>
      </div>
    </Container>
    
    <!-- Секция "Другие проекты" -->
    {otherProjects.length > 0 && (
      <Container size="project">
        <div class="mt-16 mb-16 pt-16 animate">
          <h2 class="project-label more-projects-title">
            More Projects
          </h2>
          <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
            {otherProjects.map(otherProject => (
              <a href={`/projects/${otherProject.slug}/?from=${fromParam}`} class="block group">
                <div class="flex flex-col gap-4">
                  {otherProject.data.images && otherProject.data.images.length > 0 ? (
                    <img 
                      src={otherProject.data.images[0].url} 
                      alt={otherProject.data.images[0].alt} 
                      class="aspect-square w-full object-cover rounded-lg"
                    />
                  ) : (
                    <div class="aspect-square bg-[#D9D9D9] rounded-lg"></div>
                  )}
                  <div class="flex flex-col">
                    <div class="project-value group-hover:opacity-80 transition-opacity">
                      {otherProject.data.title}
                    </div>
                    <div class="project-label">
                      {otherProject.data.projectType}
                    </div>
                  </div>
                </div>
              </a>
            ))}
          </div>
        </div>
      </Container>
    )}
    
    <CTA size="project" />
  </div>
</PageLayout>

<script is:inline>
  function initProjectPageAnimation() {
    // Проверяем URL параметры
    const urlParams = new URLSearchParams(window.location.search);
    const fromSource = urlParams.get('from');
    const hasFromParam = fromSource === 'home' || fromSource === 'projects';
    
    const pageContent = document.querySelector('.project-page-content');
    
    if (hasFromParam && pageContent) {
      // Добавляем анимацию появления страницы
      pageContent.style.opacity = '0';
      pageContent.style.transform = 'translateY(20px)';
      
      // Анимируем появление
      setTimeout(() => {
        pageContent.style.transition = 'opacity 0.4s ease-out, transform 0.4s ease-out';
        pageContent.style.opacity = '1';
        pageContent.style.transform = 'translateY(0)';
      }, 100);
    }
  }
  
  function updateMoreProjectsLinks() {
    // Получаем сохраненное значение или значение из URL
    const urlParams = new URLSearchParams(window.location.search);
    const fromSource = urlParams.get('from');
    const savedSource = sessionStorage.getItem('projectNavigationSource');
    
    // Определяем финальное значение - приоритет сохраненному
    const finalFromParam = savedSource || fromSource || 'projects';
    
    // Находим все ссылки на проекты в секции More Projects
    const moreProjectsLinks = document.querySelectorAll('a[href^="/projects/"]');
    
    moreProjectsLinks.forEach(link => {
      const url = new URL(link.href);
      // Обновляем параметр from
      url.searchParams.set('from', finalFromParam);
      link.href = url.toString();
      
      // Добавляем обработчик для сохранения позиции скролла исходной страницы
      link.addEventListener('click', function() {
        if (finalFromParam === 'home') {
          // Сохраняем позицию главной страницы только если её еще нет
          if (!sessionStorage.getItem('homeScrollPosition')) {
            // Здесь мы не можем получить позицию главной страницы, но мы можем проверить
            // была ли она уже сохранена при первом переходе
            console.log('More Projects link clicked from home context');
          }
        } else if (finalFromParam === 'projects') {
          // Аналогично для страницы проектов
          if (!sessionStorage.getItem('projectsScrollPosition')) {
            console.log('More Projects link clicked from projects context');
          }
        }
      });
    });
    
    console.log('Updated More Projects links with from:', finalFromParam);
  }
  
  // Запускаем инициализацию
  document.addEventListener('DOMContentLoaded', function() {
    initProjectPageAnimation();
    updateMoreProjectsLinks();
  });
  
  document.addEventListener('astro:page-load', function() {
    initProjectPageAnimation();
    updateMoreProjectsLinks();
  });
</script>

<style>
  /* Анимация страницы */
  .project-page-content {
    opacity: 1;
    transform: translateY(0);
    filter: blur(0px);
    transition: opacity 0.15s ease-out, transform 0.4s ease-out, filter 0.15s ease-out;
  }
  
  /* Стили для блока информации о проекте */
  .project-label {
    font-family: 'Die Grotesk B', sans-serif;
    font-style: normal;
    font-weight: 400;
    font-size: 13px;
    line-height: 120%; /* 16px */
    display: flex;
    align-items: center;
    text-align: center;
    color: rgba(0, 0, 0, 0.44);
    margin-bottom: 4px;
  }
  
  .more-projects-title {
    margin-bottom: 16px !important;
  }
  
  .project-value {
    font-family: 'Die Grotesk B', sans-serif;
    font-style: normal;
    font-weight: 400;
    font-size: 13px;
    line-height: 120%; /* 16px */
    display: flex;
    align-items: center;
    color: #000000;
  }
  
  /* Темная тема */
  @media (prefers-color-scheme: dark) {
    .project-label {
      color: rgba(255, 255, 255, 0.44);
    }
    
    .project-value {
      color: #ffffff;
    }
  }
  
  :global(html.dark) .project-label {
    color: rgba(255, 255, 255, 0.44);
  }
  
  :global(html.dark) .project-value {
    color: #ffffff;
  }

  /* Стили для контента проекта */
  :global(.astro-code) {
    @apply rounded-md text-sm my-6;
  }

  /* Стили для элементов контента проекта в соответствии с макетом блога */
  :global(.animate h2) {
    font-family: 'Tiempos Text', serif;
    font-weight: 400;
    font-size: 28px;
    line-height: 1.393em;
    letter-spacing: -0.036em;
    margin-top: 48px;
    margin-bottom: 16px;
  }
  
  :global(.animate p) {
    font-family: 'Die Grotesk B', sans-serif;
    font-weight: 400;
    font-size: 16px;
    line-height: 1.5em;
    margin-top: 24px;
    margin-bottom: 16px;
  }

  /* Дополнительные стили для списков, ссылок и других элементов */
  :global(.animate ul), :global(.animate ol) {
    font-family: 'Die Grotesk B', sans-serif;
    font-weight: 400;
    font-size: 16px;
    line-height: 1.5em;
    margin-top: 24px;
    margin-bottom: 16px;
    padding-left: 24px;
  }

  :global(.animate li) {
    margin-bottom: 16px;
    color: inherit;
  }

  /* Стили для маркеров и цифр в списках */
  :global(.animate li::marker) {
    font-family: 'Die Grotesk B', sans-serif;
    font-weight: 400;
    color: inherit;
  }

  /* Темная тема для списков */
  @media (prefers-color-scheme: dark) {
    :global(.animate li) {
      color: #ffffff;
    }
    
    :global(.animate li::marker) {
      color: #ffffff;
    }
  }

  :global(html.dark .animate li) {
    color: #ffffff;
  }

  :global(html.dark .animate li::marker) {
    color: #ffffff;
  }

  :global(.animate a) {
    color: inherit;
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  :global(.animate a:hover) {
    opacity: 0.8;
  }
</style> 