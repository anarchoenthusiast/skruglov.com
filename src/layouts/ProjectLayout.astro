---
import Container from "@components/Container.astro";
import PageLayout from "@layouts/PageLayout.astro";
import type { CollectionEntry } from "astro:content";
import CTA from "@components/CTA.astro";
import { SITE } from "@consts";
import { getCollection } from "astro:content";

interface Props {
  project: CollectionEntry<"projects">;
}

const { project } = Astro.props;
const { Content } = await project.render();

// Получаем все проекты, исключая текущий
const allProjects = await getCollection("projects");
const otherProjects = allProjects
  .filter(p => p.slug !== project.slug)
  .sort((a, b) => {
    // Если есть поле priority, сортируем по нему (меньшее значение = выше)
    if (a.data.priority !== undefined && b.data.priority !== undefined) {
      // При возрастающей сортировке первым будет проект с меньшим priority
      return a.data.priority - b.data.priority;
    }
    // Если у одного проекта есть priority, а у другого нет, приоритетный проект должен быть выше
    if (a.data.priority !== undefined && b.data.priority === undefined) {
      return -1;
    }
    if (a.data.priority === undefined && b.data.priority !== undefined) {
      return 1;
    }
    // По умолчанию сортируем по дате (более новые выше)
    return b.data.date.valueOf() - a.data.date.valueOf();
  })
  .slice(0, 3);

const breadcrumbs = [
  { label: SITE.NAME, url: '/' },
  { label: 'Projects', url: '/projects' },
  { label: project.data.title }
];
---

<PageLayout 
  title={project.data.title} 
  description={project.data.description} 
  pageType="project"
  breadcrumbs={breadcrumbs}
>
  <Container size="project">
    <div class="grid grid-cols-1 gap-8">
      <!-- Информация о проекте -->
      <div class="animate">
        <!-- Блок с информацией о проекте в две строки по три элемента -->
        <div class="space-y-6">
          <div class="grid grid-cols-2 md:grid-cols-3 gap-6">
            <div>
              <h6 class="project-label">Role</h6>
              <p class="project-value">{project.data.role}</p>
            </div>
            
            <div>
              <h6 class="project-label">Project Type</h6>
              <p class="project-value">{project.data.projectType}</p>
            </div>
            
            <div>
              <h6 class="project-label">Duration</h6>
              <p class="project-value">{project.data.duration}</p>
            </div>
          
            <div>
              <h6 class="project-label">Scope</h6>
              <p class="project-value">{project.data.scope}</p>
            </div>
            
            <div>
              <h6 class="project-label">Contributions</h6>
              <p class="project-value">{project.data.contributions}</p>
            </div>
            
            <div>
              <h6 class="project-label">Collaborators</h6>
              <p class="project-value">{project.data.collaborators}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Контент проекта и изображения -->
      <div class="animate mt-8">
        <Content />
      </div>
    </div>
  </Container>
  
  <!-- Секция "Другие проекты" -->
  {otherProjects.length > 0 && (
    <Container size="project">
      <div class="mt-16 mb-16 pt-16 animate">
        <h2 class="project-label more-projects-title">
          More Projects
        </h2>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
          {otherProjects.map(otherProject => (
            <a href={`/projects/${otherProject.slug}/`} class="block group">
              <div class="flex flex-col gap-4">
                {otherProject.data.images && otherProject.data.images.length > 0 ? (
                  <img 
                    src={otherProject.data.images[0].url} 
                    alt={otherProject.data.images[0].alt} 
                    class="aspect-square w-full object-cover rounded-lg"
                  />
                ) : (
                  <div class="aspect-square bg-[#D9D9D9] rounded-lg"></div>
                )}
                <div class="flex flex-col">
                  <div class="project-value group-hover:opacity-80 transition-opacity">
                    {otherProject.data.title}
                  </div>
                  <div class="project-label">
                    {otherProject.data.projectType}
                  </div>
                </div>
              </div>
            </a>
          ))}
        </div>
      </div>
    </Container>
  )}
  
  <CTA size="project" />
</PageLayout>

<style>
  /* Стили для блока информации о проекте */
  .project-label {
    font-family: 'Die Grotesk B', sans-serif;
    font-style: normal;
    font-weight: 400;
    font-size: 13px;
    line-height: 120%; /* 16px */
    display: flex;
    align-items: center;
    text-align: center;
    color: rgba(0, 0, 0, 0.44);
    margin-bottom: 4px;
  }
  
  .more-projects-title {
    margin-bottom: 16px !important;
  }
  
  .project-value {
    font-family: 'Die Grotesk B', sans-serif;
    font-style: normal;
    font-weight: 400;
    font-size: 13px;
    line-height: 120%; /* 16px */
    display: flex;
    align-items: center;
    color: #000000;
  }
  
  /* Темная тема */
  @media (prefers-color-scheme: dark) {
    .project-label {
      color: rgba(255, 255, 255, 0.44);
    }
    
    .project-value {
      color: #ffffff;
    }
  }
  
  :global(html.dark) .project-label {
    color: rgba(255, 255, 255, 0.44);
  }
  
  :global(html.dark) .project-value {
    color: #ffffff;
  }

  /* Стили для контента проекта */
  :global(.astro-code) {
    @apply rounded-md text-sm my-6;
  }
</style> 